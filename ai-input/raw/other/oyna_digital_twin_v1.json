{
  "version": "oyna_digital_twin_v1",
  "description": "Digital twin of Øyna Vassverk – physical, electrical, control, data & software model",
  "last_updated": "2025-12-03",

  "locations": {
    "pump_house": {
      "name": "Øyna Pump House",
      "type": "building",
      "roles": ["water_production", "buffer_storage", "pressure_boosting", "instrumentation"]
    },
    "backend_site": {
      "name": "Lillehagveien 99A",
      "type": "server_location",
      "roles": ["compute", "storage", "automation", "visualization"]
    }
  },

  "physical_system": {
    "water_source": {
      "id": "well_1",
      "type": "groundwater_well",
      "description": "Primary groundwater source for Øyna Vassverk",
      "connected_pump_id": "pump_p1"
    },
    "pumps": [
      {
        "id": "pump_p1",
        "name": "Well Pump P1",
        "type": "submersible_well_pump",
        "location": "well_1",
        "supply_voltage": "3-phase 230V",
        "control_mode": ["legacy_control_cabinet"],
        "functions": ["fill_storage_tank"],
        "electrical_feed": "dist_board_garo:kurs_5",
        "connected_to": ["tank_6000l"],
        "protection": ["motor_protection_q01", "contactor_k01", "relay_ka2", "level_sensor_p1"],
        "failsafe_behaviour": "stops_on_low_level_or_overcurrent"
      },
      {
        "id": "pump_p2",
        "name": "Pressure Pump P2",
        "type": "booster_pump",
        "location": "pump_house_floor",
        "supply_voltage": "1-phase 230V",
        "control_mode": ["legacy_control_cabinet", "smart_automation_cabinet"],
        "functions": ["maintain_network_pressure", "pressurize_pressure_tank"],
        "electrical_feed": "dist_board_garo:kurs_6",
        "connected_to": ["tank_pressure_150l", "flow_meter_sensus_620"],
        "protection": ["motor_protection_q02", "contactor_k02", "relay_ka1", "mechanical_pressure_switch"],
        "failsafe_behaviour": "stops_on_low_tank_level_overcurrent_or_manual_stop"
      }
    ],
    "tanks": [
      {
        "id": "tank_6000l",
        "name": "Main Storage Tank",
        "volume_liters": 6000,
        "type": "atmospheric_storage_tank",
        "location": "pump_house_right_wall",
        "inlet_from": "pump_p1",
        "outlet_to": "pump_p2",
        "level_sensors": ["level_sensor_p2"],
        "role": "buffer_storage"
      },
      {
        "id": "tank_pressure_150l",
        "name": "Pressure Tank",
        "volume_liters": 150,
        "type": "pressure_vessel",
        "location": "floor_near_p2",
        "inlet_from": "pump_p2",
        "outlet_to": "flow_meter_sensus_620",
        "role": "pressure_stabilization"
      }
    ],
    "flow_measurement": {
      "id": "flow_meter_sensus_620",
      "name": "Sensus 620 Main Water Meter",
      "type": "mechanical_water_meter",
      "location": "downstream_of_pressure_tank",
      "connected_pulse_sensor": "pulse_hri_1",
      "downstream_to": "distribution_network_all_cabins"
    },
    "sensors": [
      {
        "id": "level_sensor_p1",
        "name": "Water Level Sensor – P1",
        "type": "level_switch",
        "location": "well_1_or_suction_area",
        "connected_to": "control_cabinet_old",
        "role": "dry_run_protection_p1"
      },
      {
        "id": "level_sensor_p2",
        "name": "Water Level Sensor – P2",
        "type": "level_switch",
        "location": "tank_6000l",
        "connected_to": "control_cabinet_old",
        "role": "low_tank_protection_p2"
      }
    ],
    "heating": [
      {
        "id": "heater_room",
        "name": "Pump House Heater",
        "type": "electric_panel_heater",
        "location": "pump_house_wall",
        "electrical_feed": "dist_board_garo:kurs_4",
        "role": "frost_protection"
      }
    ],
    "distribution": {
      "id": "distribution_network_all_cabins",
      "type": "pipe_network",
      "pipe_sizes_mm": [32, 40],
      "source": "flow_meter_sensus_620",
      "description": "Main distribution network to all cabins at Øyna"
    }
  },

  "electrical_system": {
    "distribution_boards": [
      {
        "id": "dist_board_garo",
        "name": "GARO Main Distribution Board",
        "location": "pump_house",
        "main_incoming": {
          "protection": "overcurrent_32A",
          "voltage_system": "230V",
          "type": "main_inlet"
        },
        "circuits": [
          {
            "id": "kurs_4",
            "name": "Lights and Sockets",
            "rating_amps": 10,
            "type": "radial",
            "loads": ["heater_room", "wifi_ruckus_r310", "shelly_1_gen4_box", "general_sockets"]
          },
          {
            "id": "kurs_5",
            "name": "Well Pump P1",
            "rating_amps": 16,
            "type": "motor_circuit",
            "downstream_to": "control_cabinet_old:q01_k01_p1"
          },
          {
            "id": "kurs_6",
            "name": "Pressure Pump P2",
            "rating_amps": 16,
            "type": "motor_circuit",
            "downstream_to": "control_cabinet_old_and_automation_cabinet:p2"
          }
        ],
        "protection_devices": [
          "overcurrent_32A",
          "residual_current_device",
          "surge_protection_device"
        ]
      }
    ],
    "control_cabinets": [
      {
        "id": "control_cabinet_old",
        "name": "Legacy Control Cabinet",
        "location": "pump_house_wall",
        "role": "motor_control_and_safety",
        "supplied_from": ["dist_board_garo:kurs_5", "dist_board_garo:kurs_6"],
        "components": [
          {
            "id": "q01",
            "type": "motor_protection",
            "role": "overload_and_short_circuit_protection_p1"
          },
          {
            "id": "k01",
            "type": "contactor",
            "role": "switched_supply_to_p1"
          },
          {
            "id": "q02",
            "type": "motor_protection",
            "role": "overload_and_short_circuit_protection_p2"
          },
          {
            "id": "k02",
            "type": "contactor",
            "role": "switched_supply_to_p2_or_downstream_automation"
          },
          {
            "id": "ka1",
            "type": "auxiliary_relay",
            "role": "interlock_and_level_logic_for_p2"
          },
          {
            "id": "ka2",
            "type": "auxiliary_relay",
            "role": "interlock_and_level_logic_for_p1"
          },
          {
            "id": "t01",
            "type": "control_transformer",
            "role": "provides_control_voltage_for_relays_and_sensors"
          }
        ],
        "functions": [
          "legacy_p1_start_stop",
          "legacy_p2_enable_disable",
          "low_level_protection_p1",
          "low_tank_protection_p2"
        ]
      },
      {
        "id": "automation_cabinet_new",
        "name": "Automation Cabinet (Shelly / ABB)",
        "location": "pump_house_wall",
        "role": "smart_control_for_p2_and_measurement",
        "supplied_from": "dist_board_garo:kurs_6",
        "components": [
          {
            "id": "shelly_pro_em50",
            "type": "smart_energy_meter_and_relay",
            "channels": ["p2_power_measurement", "p2_contactor_control"],
            "monitored_loads": ["pump_p2"],
            "control_output": "abb_contactor_p2"
          },
          {
            "id": "abb_contactor_p2",
            "type": "contactor",
            "role": "final_power_switch_to_p2_in_auto_mode"
          },
          {
            "id": "auto_manual_switch_p2",
            "type": "selector_switch",
            "positions": ["manual_legacy_only", "auto_shelly_and_legacy"],
            "role": "mode_selection_for_p2"
          }
        ]
      }
    ]
  },

  "sensors_and_devices": {
    "iot_devices": [
      {
        "id": "shelly_1_gen4",
        "name": "Shelly 1 Gen4 – Water Meter",
        "type": "iot_pulse_counter",
        "location": "small_box_near_flow_meter",
        "power_source": "dist_board_garo:kurs_4",
        "connected_sensor": "pulse_hri_1",
        "outputs": [
          "waterflow_lpm",
          "waterflow_total_liters",
          "pulse_count"
        ]
      },
      {
        "id": "pulse_hri_1",
        "name": "Sensus HRI Pulse Adapter",
        "type": "pulse_output_sensor",
        "connected_to": "flow_meter_sensus_620",
        "output_to": "shelly_1_gen4"
      },
      {
        "id": "shelly_pro_em50",
        "name": "Shelly Pro EM50",
        "type": "iot_energy_meter_and_switch",
        "location": "automation_cabinet_new",
        "monitors": ["pump_p2_power"],
        "controls": ["abb_contactor_p2"],
        "channels": ["voltage", "current", "active_power", "energy", "relay_output"]
      }
    ],
    "network_devices": [
      {
        "id": "wifi_ruckus_r310",
        "name": "Ruckus R310 WiFi AP",
        "type": "wifi_access_point",
        "location": "pump_house",
        "role": "local_wireless_connectivity_for_shelly_devices"
      }
    ]
  },

  "network_and_communication": {
    "protocols": ["MQTT", "HTTP", "WebSocket"],
    "pump_house_to_backend": {
      "path": [
        "shelly_devices_wifi",
        "wifi_ruckus_r310",
        "internet",
        "nginx_proxy_manager",
        "home_assistant_host"
      ],
      "security": {
        "mqtt_tls": "configurable",
        "external_access": "duckdns_domain"
      }
    },
    "mqtt": {
      "broker": {
        "id": "mosquitto_ha_addon",
        "location": "backend_site",
        "hosted_on": "home_assistant_os"
      },
      "topics": {
        "flow_meter": [
          "shelly/1g4/liters_per_minute",
          "shelly/1g4/total_liters",
          "shelly/1g4/events"
        ],
        "pump_em50": [
          "shelly/proem50/status/em1:0",
          "shelly/proem50/status/switch:0",
          "shelly/proem50/command/switch:0"
        ]
      }
    }
  },

  "software_stack": {
    "home_assistant": {
      "core_version": "2025.11.3",
      "os_type": "Home Assistant OS",
      "role": "central_state_and_control_platform",
      "integrations": [
        "mqtt",
        "shelly",
        "influxdb",
        "node_red",
        "helpers"
      ],
      "entities": {
        "flow": [
          "sensor.waterflow_lpm",
          "sensor.waterflow_total_liters"
        ],
        "pump_power": [
          "sensor.pressure_pump_voltage",
          "sensor.pressure_pump_current",
          "sensor.pressure_pump_active_power"
        ],
        "pump_state": [
          "binary_sensor.pressure_pump_running",
          "switch.pressure_pump_contactor"
        ],
        "virtual": [
          "sensor.virtual_pressure",
          "sensor.pump_cycle_liters",
          "sensor.pump_cycle_runtime",
          "sensor.leak_score",
          "sensor.night_usage_liters"
        ],
        "input_helpers": [
          "input_number.virtual_pressure_cutin",
          "input_number.virtual_pressure_cutout",
          "input_boolean.pump_auto_mode",
          "input_boolean.force_pump_shutdown"
        ]
      }
    },
    "node_red": {
      "version": "4.1.1",
      "role": "logic_engine_and_automation_brain",
      "main_flows": [
        {
          "id": "flow_waterflow_ingest",
          "name": "Waterflow Ingest",
          "functions": [
            "mqtt_in_to_waterflow_lpm",
            "mqtt_in_to_total_liters",
            "basic_validation",
            "write_to_influx_raw"
          ]
        },
        {
          "id": "flow_pump_cycle_detection",
          "name": "Pump Cycle Detection",
          "inputs": [
            "binary_sensor.pressure_pump_running",
            "sensor.pressure_pump_active_power"
          ],
          "outputs": [
            "cycle_start_events",
            "cycle_end_events",
            "cycle_liters",
            "cycle_runtime"
          ],
          "writes_to": [
            "influx_pressure_bucket",
            "ha_virtual_sensors"
          ]
        },
        {
          "id": "flow_virtual_pressure",
          "name": "Virtual Pressure Model",
          "inputs": [
            "cycle_liters",
            "cutin_setting",
            "cutout_setting"
          ],
          "outputs": [
            "sensor.virtual_pressure"
          ]
        },
        {
          "id": "flow_leakage_detection",
          "name": "Leakage Detection",
          "inputs": [
            "night_flow_data",
            "baseline_usage",
            "cycle_statistics"
          ],
          "outputs": [
            "sensor.leak_score",
            "leakage_alarms"
          ]
        },
        {
          "id": "flow_pump_safety_logic",
          "name": "Pump Safety Logic",
          "inputs": [
            "sensor.leak_score",
            "frost_risk",
            "manual_shutdown",
            "system_health"
          ],
          "actions": [
            "turn_off_switch.pressure_pump_contactor",
            "notify_ha_or_operator"
          ]
        }
      ]
    },
    "influxdb": {
      "role": "time_series_storage",
      "buckets": [
        {
          "id": "haos-oyna-raw",
          "description": "Raw MQTT measurements from Shelly devices"
        },
        {
          "id": "haos-oyna-waterflow",
          "description": "Aggregated flow metrics (minute, hour, day)"
        },
        {
          "id": "haos-oyna-pressure",
          "description": "Virtual pressure, cycles and runtimes"
        },
        {
          "id": "haos-oyna-leakage",
          "description": "Leak scores and nightly usage baselines"
        }
      ]
    }
  },

  "safety_and_failover": {
    "mechanical_failsafes": [
      "level_sensor_p1_dry_run_protection",
      "level_sensor_p2_low_tank_protection",
      "motor_protection_q01_overcurrent_p1",
      "motor_protection_q02_overcurrent_p2",
      "mechanical_pressure_switch_p2"
    ],
    "digital_failsafes": [
      "node_red_leakage_shutdown",
      "node_red_frost_shutdown",
      "manual_force_pump_shutdown_via_ha",
      "auto_manual_switch_p2_fallback_to_legacy"
    ],
    "operating_modes": [
      {
        "id": "mode_legacy_only",
        "description": "Pumps controlled only by legacy cabinet logic and mechanical switches",
        "requirements": [
          "auto_manual_switch_p2=manual_legacy_only",
          "node_red_not_required"
        ]
      },
      {
        "id": "mode_smart_auto",
        "description": "Legacy logic + Shelly EM50 + Node-RED + HA for advanced control",
        "requirements": [
          "auto_manual_switch_p2=auto_shelly_and_legacy",
          "mqtt_available",
          "node_red_running"
        ]
      }
    ]
  }
}
