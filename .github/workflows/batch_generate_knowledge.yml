name: Batch Generate Knowledge (all raw files)

on:
  workflow_dispatch:  # run manually from the Actions tab

jobs:
  list-files:
    runs-on: ubuntu-latest
    outputs:
      matrix: ${{ steps.set-matrix.outputs.matrix }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - id: set-matrix
        run: |
          python - << 'PY' >> $GITHUB_OUTPUT
          import json, pathlib
          root = pathlib.Path("ai-input/raw")
          files = [str(p) for p in root.rglob("*") if p.is_file()]
          matrix = {"include": [{"file": f} for f in files]}
          print("matrix=" + json.dumps(matrix))
          PY

  generate:
    needs: list-files
    runs-on: ubuntu-latest
    strategy:
      max-parallel: 1   # important to avoid rate limits
      matrix: ${{ fromJson(needs.list-files.outputs.matrix) }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: "3.11"

      - name: Install dependencies
        run: pip install openai pypdf python-docx

      - name: Run generator for one file
        env:
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
          RAW_SINGLE_FILE: ${{ matrix.file }}
        run: python tools/generate_knowledge.py

      - name: Commit generated knowledge & moved files
        uses: stefanzweifel/git-auto-commit-action@v4
        with:
          commit_message: "Batch generate knowledge modules"
